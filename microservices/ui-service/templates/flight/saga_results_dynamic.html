
{% extends 'flight/layout.html' %}
{% load static %}

{% block head %}
<title>SAGA Transaction Results | Flight Booking</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
    .saga-header { 
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); 
        color: white; 
        padding: 40px; 
        border-radius: 12px; 
        margin-bottom: 30px; 
        text-align: center; 
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); 
    }
    .saga-header h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 10px; }
    .status-card { 
        background: white; 
        border-radius: 12px; 
        padding: 30px; 
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); 
        border-left: 5px solid #dc3545; 
        margin-bottom: 20px; 
    }
    .status-badge { 
        display: inline-flex; 
        align-items: center; 
        gap: 6px; 
        padding: 6px 12px; 
        border-radius: 20px; 
        font-size: 0.85rem; 
        font-weight: 600; 
    }
    .status-error { background: #fef2f2; color: #ef4444; }
    .btn-custom { 
        display: inline-block; 
        padding: 12px 30px; 
        margin: 0 10px; 
        border-radius: 8px; 
        text-decoration: none; 
        font-weight: 600; 
        transition: all 0.3s ease; 
    }
    .log-container {
        background: #1e1e1e;
        color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        max-height: 400px;
        overflow-y: auto;
        margin: 20px 0;
        border: 1px solid #495057;
    }
    .log-entry {
        margin-bottom: 8px;
        padding: 4px 0;
        border-bottom: 1px solid #343a40;
    }
    .log-timestamp {
        color: #6c757d;
        margin-right: 10px;
    }
    .log-level-info { color: #17a2b8; }
    .log-level-error { color: #dc3545; font-weight: bold; }
    .log-level-success { color: #28a745; }
    .log-level-warning { color: #ffc107; }
    .log-level-compensation { color: #fd7e14; }
</style>
{% endblock %}

{% block body %}
<!-- Hidden data for JavaScript -->
<script id="saga-logs-data" type="application/json">{{ saga_logs|safe }}</script>

<div class="saga-header">
    <div class="container">
        <h1><i class="fas fa-exclamation-triangle"></i> SAGA Transaction Results</h1>
        <p>Distributed Transaction with Real-Time Logging</p>
        {% if correlation_id %}
            <div style="background: rgba(255, 255, 255, 0.2); padding: 15px; border-radius: 8px; margin-top: 20px;">
                <strong>Correlation ID:</strong> {{ correlation_id }}
            </div>
        {% endif %}
    </div>
</div>

<div class="container">
    <div class="status-card">
        <h3><i class="fas fa-info-circle"></i> Transaction Status</h3>
        {% if saga_status %}
            <div class="status-badge status-error">
                <i class="fas fa-times-circle"></i>
                {{ saga_status.status|title }} at {{ saga_status.failed_step }}
            </div>
            <p><strong>Error:</strong> {{ saga_status.error }}</p>
            <p><strong>Steps Completed:</strong> {{ saga_status.steps_completed }}/{{ saga_status.total_steps }}</p>
            {% if saga_status.compensations_executed %}
                <p><strong>Compensations:</strong> {{ saga_status.compensations_executed }} executed successfully</p>
            {% endif %}
        {% else %}
            <div class="status-badge status-error">
                <i class="fas fa-times-circle"></i>
                Transaction Failed
            </div>
            <p>Unable to retrieve detailed status information.</p>
        {% endif %}
    </div>

    <div class="status-card">
        <h3><i class="fas fa-list-alt"></i> Real-Time Execution Logs</h3>
        <p>These logs show the actual SAGA execution flow and compensation actions:</p>
        
        <!-- Placeholder for dynamic logs - will be replaced by JavaScript -->
        <div id="dynamic-saga-logs-placeholder">
            <div class="log-container">
                <div style="text-align: center; padding: 20px; color: #6c757d;">
                    <i class="fas fa-spinner fa-spin"></i> Loading real-time logs...
                </div>
            </div>
        </div>
    </div>

    <div class="status-card">
        <h3><i class="fas fa-undo"></i> What Happened?</h3>
        <p>Your booking attempt failed during the distributed transaction process. Here's what our system did:</p>
        <ul>
            <li><strong>Automatic Rollback:</strong> All completed steps were automatically reversed</li>
            <li><strong>No Charges:</strong> No payment was processed due to the failure</li>
            <li><strong>Data Consistency:</strong> Your account and loyalty points remain unchanged</li>
            <li><strong>System Recovery:</strong> All services are ready for your next booking attempt</li>
        </ul>
    </div>

    <div class="text-center" style="margin: 40px 0;">
        <a href="{% url 'index' %}" class="btn-custom" style="background: #007bff; color: white;">
            <i class="fas fa-search"></i> Search Flights Again
        </a>
        <a href="{% url 'bookings' %}" class="btn-custom" style="background: #6c757d; color: white;">
            <i class="fas fa-list"></i> View My Bookings
        </a>
    </div>
</div>

<script src="{% static 'js/saga_results.js' %}"></script>
{% endblock %}