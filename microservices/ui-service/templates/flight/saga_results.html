
{% extends 'flight/layout.html' %}
{% load static %}

{% block head %}
<title>SAGA Transaction Failed | Flight Booking</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
    .saga-header { 
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); 
        color: white; 
        padding: 40px; 
        border-radius: 12px; 
        margin-bottom: 30px; 
        text-align: center; 
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); 
    }
    .saga-header h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 10px; }
    .status-card { 
        background: white; 
        border-radius: 12px; 
        padding: 30px; 
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); 
        border-left: 5px solid #dc3545; 
        margin-bottom: 20px; 
    }
    .status-badge { 
        display: inline-flex; 
        align-items: center; 
        gap: 6px; 
        padding: 6px 12px; 
        border-radius: 20px; 
        font-size: 0.85rem; 
        font-weight: 600; 
    }
    .status-error { background: #fef2f2; color: #ef4444; }
    .btn-custom { 
        display: inline-block; 
        padding: 12px 30px; 
        margin: 0 10px; 
        border-radius: 8px; 
        text-decoration: none; 
        font-weight: 600; 
        transition: all 0.3s ease; 
    }
    .log-container {
        background: #1e1e1e;
        color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        max-height: 500px;
        overflow-y: auto;
        margin: 20px 0;
        border: 1px solid #495057;
    }
    .log-entry {
        margin-bottom: 8px;
        padding: 4px 0;
        border-bottom: 1px solid #343a40;
    }
    .log-timestamp {
        color: #6c757d;
        margin-right: 10px;
    }
    .log-level-info { color: #17a2b8; }
    .log-level-error { color: #dc3545; font-weight: bold; }
    .log-level-success { color: #28a745; }
    .log-level-warning { color: #ffc107; }
    .log-level-compensation { color: #fd7e14; }
    .loading-indicator {
        text-align: center;
        padding: 20px;
        color: #6c757d;
        font-style: italic;
    }
</style>
{% endblock %}

{% block body %}
<div class="saga-header">
    <div class="container">
        <h1><i class="fas fa-exclamation-triangle"></i> SAGA Transaction Failed</h1>
        <p>Distributed Transaction Failed with Automatic Compensation</p>
        {% if correlation_id %}
            <div style="background: rgba(255, 255, 255, 0.2); padding: 15px; border-radius: 8px; margin-top: 20px;">
                <strong>Correlation ID:</strong> {{ correlation_id }}
            </div>
            
            <div class="container">
                {% if correlation_id %}
                    <!-- Real System Logs Section -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="status-card">
                                <h4><i class="fas fa-terminal"></i> SAGA Transaction Logs</h4>
                                <p>Detailed execution logs showing step-by-step processing and compensation:</p>
                                
                                <div class="log-container">
                                    <div id="dynamic-saga-logs">
                                        <div class="loading-indicator">
                                            <i class="fas fa-spinner fa-spin"></i> Loading detailed transaction logs...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        {% endif %}
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const correlationId = '{{ correlation_id }}';
        if (correlationId && correlationId !== 'unknown') {
            fetch(`/api/saga/logs/${correlationId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.logs) {
                        const container = document.getElementById('dynamic-saga-logs');
                        if (container) {
                            container.innerHTML = `
                                <div style="background: #28a745; color: white; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-weight: bold;">
                                    ðŸ“Š SAGA Transaction Logs - Correlation ID: ${correlationId}
                                </div>
                                <div style="background: #17a2b8; color: white; padding: 8px; border-radius: 5px; margin-bottom: 10px; font-size: 12px;">
                                    ðŸ”„ Streaming logs in real-time... (${data.logs.length} entries)
                                </div>
                            `;
                            
                            data.logs.forEach(log => {
                                const comp = log.is_compensation ? ' [COMPENSATION]' : '';
                                const level = log.is_compensation ? 'compensation' : log.log_level;
                                container.innerHTML += `
                                    <div class="log-entry">
                                        <span class="log-timestamp">[${log.timestamp}]</span>
                                        <span class="log-level-${level}">[${log.service}${comp}]</span> ${log.message}
                                    </div>
                                `;
                            });
                        }
                    }
                })
                .catch(error => console.error('Error fetching logs:', error));
        }
    });
    </script>
    
    {% endblock %}
</div>