{% extends 'flight/layout.html' %}

{% load static %}
{% load currency_filters %}

{% block head %}
    <title>Payment | Flight</title>
    <link rel="stylesheet" href="{% static 'css/payment_style.css' %}">
{% endblock %}

{% block body %}
    <section class="section section1">
        <div class="container">
            <div class="payment-box">
                <div class="payment-box-head-div">
                    <div class="payment-box-head">
                        <h5>Payment Details</h5>
                        <div class="display-td">
                            <img class="card-img" src="{% static 'img/card.png' %}">
                        </div>
                    </div>
                </div>
                <div class="payment-details-input-box">
                    <form action="{% url 'payment' %}" method="POST">
                        {% csrf_token %}
                        <!--<input type="hidden" name="payment_amount" value="{{fare}}">-->
                        <input type="hidden" name="ticket" value="{{ticket}}" required>
                        {% if ticket2 %}
                            <input type="hidden" name="ticket2" value="{{ticket2}}" required>
                        {% endif %}
                        <!-- Points Redemption Section -->
                        {% if user.is_authenticated %}
                        <div class="row miles-redemption-div" style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #f8f9fa;">
                            <div class="col-12">
                                <h6 style="color: #007bff; margin-bottom: 15px;">$ Use Loyalty Points</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="available_miles">Available Miles</label>
                                            <input type="text" class="form-control" id="available_miles" value="{{user_points|default:0}} miles" disabled>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="miles_value">Miles Value</label>
                                            <input type="text" class="form-control" id="miles_value" value="${{points_value|default:0|format_usd}}" disabled>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="form-group">
                                            <label for="miles_to_use">Miles to Use</label>
                                            <input type="number" class="form-control" id="miles_to_use" name="points_to_use" min="0" max="{{user_points|default:0}}" placeholder="Enter miles to redeem" onchange="calculateHybridPayment()">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label>&nbsp;</label>
                                            <button type="button" class="btn btn-outline-primary btn-block" onclick="useMaxPoints()">Use Max</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                        <small class="text-muted">1 mile = $0.01 â€¢ Maximum {{user_points|default:0}} miles available</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Payment Method Selection -->
                        <div class="row payment-method-div" style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #f8f9fa;">
                            <div class="col-12">
                                <h6 style="color: #007bff; margin-bottom: 15px;">ðŸ’³ Payment Method</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="payment_method" id="card_payment" value="card" checked onchange="togglePaymentMethod()">
                                    <label class="form-check-label" for="card_payment">
                                        <strong>Pay with Card</strong> - Complete payment now
                                    </label>
                                </div>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="radio" name="payment_method" id="counter_payment" value="counter" onchange="togglePaymentMethod()">
                                    <label class="form-check-label" for="counter_payment">
                                        <strong>Pay at Airport Counter</strong> - Hold ticket and pay remaining amount at airport
                                    </label>
                                </div>
                                <div id="counter_payment_info" class="mt-2" style="display: none;">
                                    <div class="alert alert-info">
                                        <small>
                                            <i class="fas fa-info-circle"></i>
                                            Your ticket will be placed on hold. You must complete payment at the airport counter before your flight departure.
                                            Points will be redeemed immediately, but remaining amount must be paid at counter.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row payment-amount-div">
                            <div class="form-group">
                                <label for="payment_amount">PAYMENT AMOUNT</label>
                                <input type="text" class="form-control" id="payment_amount" name="fare" value="$ {{fare|inr_to_usd|format_usd}}" disabled required>
                                <input type="hidden" id="original_fare" value="{{fare|inr_to_usd|format_usd}}">
                                <input type="hidden" id="final_fare" name="final_fare" value="{{fare|inr_to_usd|format_usd}}">
                            </div>
                        </div>
                        <div class="row card-no-div">
                            <div class="form-group">
                                <label for="card_number">CARD NUMBER</label>
                                <div class="input-group">
                                    <input type="tel" pattern="[0-9]{16}" class="form-control" id="card_number" name="cardNumber" autocomplete="off" minlength="16" maxlength="16" placeholder="Enter card number" title="Please enter a valid card number (16 digits)" required>
                                    <div class="input-group-append">
                                        <span class="input-group-text" id="basic-addon2">
                                        <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-credit-card" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                            <path fill-rule="evenodd" d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm2-1a1 1 0 0 0-1 1v1h14V4a1 1 0 0 0-1-1H2zm13 4H1v5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V7z"/>
                                            <path d="M2 10a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-1z"/>
                                        </svg>
                                        </span>
                                    </div>
                                </div>
                                <small class="text-muted">Enter exactly 16 digits</small>
                            </div>
                        </div>
                        <div class="row card-holder-div">
                            <div class="form-group">
                                <label for="card_holder_name">CARD HOLDER'S NAME</label>
                                <input type="text" name="cardHolderName" class="form-control" id="cardHolderName" placeholder="Enter name" pattern="[A-Za-z\s]{2,50}" minlength="2" maxlength="50" title="Please enter a valid name (2-50 characters, letters only)" required>
                                <small class="text-muted">Letters only, 2-50 characters</small>
                            </div>
                        </div>
                        <div class="row expiry-cvv">
                            <div class="row">
                                <div class="left-col">
                                    <label for="expiry_month">EXPIRY DATE</label>
                                    <div class="expiry-input-div">
                                        <div class="month-div">
                                            <select name="expMonth" id="expiry_month" class="form-control" required>
                                                <option value="">Month</option>
                                                <option value="01">01</option>
                                                <option value="02">02</option>
                                                <option value="03">03</option>
                                                <option value="04">04</option>
                                                <option value="05">05</option>
                                                <option value="06">06</option>
                                                <option value="07">07</option>
                                                <option value="08">08</option>
                                                <option value="09">09</option>
                                                <option value="10">10</option>
                                                <option value="11">11</option>
                                                <option value="12">12</option>
                                            </select>
                                        </div>
                                        <div class="yeae-div">
                                            <select name="expYear" id="expiry_year" class="form-control" required>
                                                <option value="">Year</option>
                                                <option value="2020">2020</option>
                                                <option value="2021">2021</option>
                                                <option value="2022">2022</option>
                                                <option value="2023">2023</option>
                                                <option value="2024">2024</option>
                                                <option value="2025">2025</option>
                                                <option value="2026">2026</option>
                                                <option value="2027">2027</option>
                                                <option value="2028">2028</option>
                                                <option value="2029">2029</option>
                                                <option value="2030">2030</option>
                                                <option value="2031">2031</option>
                                                <option value="2032">2032</option>
                                                <option value="2033">2033</option>
                                                <option value="2034">2034</option>
                                                <option value="2035">2035</option>
                                                <option value="2036">2036</option>
                                                <option value="2037">2037</option>
                                                <option value="2038">2038</option>
                                                <option value="2039">2039</option>
                                                <option value="2040">2040</option>
                                                <option value="2041">2041</option>
                                                <option value="2042">2042</option>
                                                <option value="2043">2043</option>
                                                <option value="2044">2044</option>
                                                <option value="2045">2045</option>
                                                <option value="2046">2046</option>
                                                <option value="2047">2047</option>
                                                <option value="2048">2048</option>
                                                <option value="2049">2049</option>
                                                <option value="2050">2050</option>
                                                <option value="2051">2051</option>
                                                <option value="2052">2052</option>
                                                <option value="2053">2053</option>
                                                <option value="2054">2054</option>
                                                <option value="2055">2055</option>
                                                <option value="2056">2056</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="right-col">
                                    <div class="form-group">
                                        <label for="cvv_number">CVV CODE</label>
                                        <input type="password" pattern="[0-9]{3}" class="form-control" placeholder="CVV" id="cvv_number" name="cvv" minlength="3" maxlength="3" title="Please enter a valid CVV (3 digits)">
                                        <!--<small id="nameHelp" class="form-text text-muted">We'll never share your email with anyone else.</small>-->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="payment-btn">
                            <button type="submit" class="btn btn-primary" id="payment_button">Make payment</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>



    </section>

    <script>
        // Points redemption functionality
        const originalFare = parseFloat(document.getElementById('original_fare').value) || 0;
        const userPoints = parseInt('{{ user_points|default:0 }}') || 0;

        function calculateHybridPayment() {
            const milesToUse = parseInt(document.getElementById('miles_to_use').value) || 0;
            const maxMiles = Math.min(userPoints, Math.floor(originalFare * 100)); // Max miles that can be used (1 mile = $0.01)

            // Validate miles input
            if (milesToUse > maxMiles) {
                document.getElementById('miles_to_use').value = maxMiles;
                return calculateHybridPayment();
            }
            
            // Calculate miles value (1 mile = $0.01)
            const milesValueUsed = milesToUse * 0.01;
            const remainingAmount = Math.max(0, originalFare - milesValueUsed);
            
            // Update payment amount display
            document.getElementById('payment_amount').value = `$ ${remainingAmount.toFixed(2)}`;
            document.getElementById('final_fare').value = remainingAmount.toFixed(2);
            
            // Update miles value display
            if (document.getElementById('miles_value')) {
                document.getElementById('miles_value').value = `$${milesValueUsed.toFixed(2)}`;
            }

            // Show savings if any miles are used
            if (milesToUse > 0) {
                document.getElementById('payment_amount').style.color = '#28a745';
                document.getElementById('payment_amount').style.fontWeight = 'bold';
            } else {
                document.getElementById('payment_amount').style.color = '';
                document.getElementById('payment_amount').style.fontWeight = '';
            }
        }

        function useMaxPoints() {
            const maxMiles = Math.min(userPoints, Math.floor(originalFare * 100));
            document.getElementById('miles_to_use').value = maxMiles;
            calculateHybridPayment();
        }

        // Payment method toggle functionality
        function togglePaymentMethod() {
            const cardPayment = document.getElementById('card_payment').checked;
            const counterPayment = document.getElementById('counter_payment').checked;
            
            // Get all card payment sections
            const cardSections = [
                'card_payment_section',
                'card_holder_section',
                'expiry_cvv_section'
            ];
            
            // Toggle visibility and required attributes
            cardSections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.style.display = cardPayment ? 'block' : 'none';
                }
            });
            
            // Toggle required attributes for card fields
            const cardFields = ['card_number', 'cardHolderName', 'expiry_month', 'expiry_year', 'cvv_number'];
            cardFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    if (cardPayment) {
                        field.setAttribute('required', 'required');
                    } else {
                        field.removeAttribute('required');
                    }
                }
            });
            
            // Show/hide counter payment info
            const counterInfo = document.getElementById('counter_payment_info');
            if (counterInfo) {
                counterInfo.style.display = counterPayment ? 'block' : 'none';
            }
            
            // Update button text
            const paymentButton = document.getElementById('payment_button');
            if (paymentButton) {
                if (counterPayment) {
                    paymentButton.textContent = 'Hold Ticket & Pay at Counter';
                    paymentButton.className = 'btn btn-warning btn-block';
                } else {
                    paymentButton.textContent = 'Make Payment';
                    paymentButton.className = 'btn btn-primary';
                }
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            calculateHybridPayment();
            togglePaymentMethod(); // Initialize payment method display
        });
    </script>
{% endblock %}