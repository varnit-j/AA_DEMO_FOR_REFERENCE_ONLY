
# local_templates/modules.yml
version: 1
project: "Flight-booking"

phases:
  - slug: env
    description: Environment & scripts
  - slug: loyalty
    description: Rewards ledger (earn/burn), tiers, constraints
  - slug: orders
    description: Order/Settlement domain & hybrid pricing
  - slug: payments
    description: Stripe cash leg (PaymentIntents/Checkout, webhooks)
  - slug: hybrid
    description: Hybrid checkout UX (points + cash)
  - slug: receipts
    description: Boarding pass PDF, emails, ICS
  - slug: scheduler
    description: Points expiry & payment reminder commands
  - slug: ui_shiny
    description: Shiny for Python UI micro-app (hybrid dashboard)
  - slug: perf
    description: Local-memory caching & logging

modules:

  # ===== Loyalty Foundation =====
  - id: loyalty_foundation
    phase: loyalty
    goal: "Implement loyalty ledger: accrual/redemption, tiers, constraints."
    mode: architect
    status: completed
    outputs:
      files:
        - apps/loyalty/models.py
        - apps/loyalty/service.py
        - apps/loyalty/admin.py
        - apps/loyalty/views.py
        - apps/loyalty/urls.py
        - apps/loyalty/templates/loyalty/dashboard.html
        - apps/loyalty/templates/loyalty/points_history.html
        - apps/loyalty/templates/loyalty/tier_info.html
        - apps/loyalty/management/commands/setup_loyalty_data.py
        - tests/test_loyalty.py
    features:
      - "Points earning: 2% of booking amount as loyalty points"
      - "Tier system: Bronze, Silver, Gold, Platinum with multipliers"
      - "Points redemption: 1 point = $0.01 value"
      - "Transaction history and dashboard"
      - "Automatic tier upgrades based on points earned"
      - "Unicode-safe point calculations and display"
    integration:
      - "Integrated with flight booking payment flow"
      - "Points awarded automatically on successful payment"
      - "Points can be redeemed during checkout"
    steps:
      - name: design
        mode: architect
        description: Schema for PointsTransaction; tier multipliers; redemption floors.
        status: completed
      - name: implement
        mode: code
        status: completed
      - name: debug
        mode: debug
        status: completed
      - name: payment_integration
        mode: code
        description: "Integrate loyalty points with flight booking payment flow"
        status: completed
      - name: unicode_fixes
        mode: debug
        description: "Fix Unicode encoding issues in loyalty point display and calculations"
        status: completed

  # ===== Orders & Settlement =====
  - id: orders_core
    phase: orders
    goal: "Create Order, OrderLine, Settlement; compute totals and hybrid math."
    mode: architect
    outputs:
      files:
        - apps/orders/models.py
        - apps/orders/service.py
        - tests/test_orders.py
    steps:
      - name: design
        mode: architect
        description: Settlement captures points debited + cash captured + statuses.
      - name: implement
        mode: code
      - name: debug
        mode: debug

  # ===== Cash Payments (Stripe) =====
  - id: stripe_cash
    phase: payments
    goal: "Add Stripe PaymentIntents/Checkout endpoints + webhooks."
    mode: architect
    inputs:
      env:
        - STRIPE_PUBLISHABLE_KEY
        - STRIPE_SECRET_KEY
        - STRIPE_WEBHOOK_SECRET
    outputs:
      files:
        - apps/payments/stripe_client.py
        - payments/views.py
        - payments/webhooks.py
        - tests/test_payments.py
      routes:
        - POST /payments/create-checkout-session
        - POST /payments/create-intent
        - POST /payments/webhook
    steps:
      - name: design
        mode: architect
        description: Choose Checkout vs Elements; allow manual capture if needed.
      - name: implement
        mode: code
      - name: debug
        mode: debug
        notes: "Stripe CLI for webhook forwarding."

  # ===== Hybrid Checkout (Points + Cash) =====
  - id: hybrid_checkout
    phase: hybrid
    goal: "Redeem points, compute remainder, initiate cash leg."
    mode: architect
    outputs:
      files:
        - flight/views/hybrid_checkout.py
        - flight/templates/flight/hybrid_checkout.html
        - tests/test_hybrid.py
      routes:
        - POST /checkout/hybrid/redeem
        - POST /checkout/hybrid/pay
    steps:
      - name: design
        mode: architect
        description: UX: points input → preview totals → confirm → cash flow start.
      - name: implement
        mode: code
      - name: debug
        mode: debug
        notes: "Staged cash: Stripe invoice with partial payments."

  # ===== Shiny UI (Hybrid Dashboard) =====
  - id: shiny_hybrid_ui
    phase: ui_shiny
    goal: "Interactive dashboard for points redemption, pricing visualization, seat class selection, and payment kickoff."
    mode: architect
    outputs:
      files:
        - ui/shiny/app.py
        - ui/shiny/www/custom.css
        - ui/shiny/tests/test_app.py
        - flight/templates/flight/hybrid_shiny.html
    steps:
      - name: design
        mode: architect
        description: Define Shiny inputs (points to redeem, class, seat selection) and outputs (net payable, charts).
      - name: implement
        mode: code
        description: Build PyShiny app; call Django `/checkout/hybrid/redeem` & `/payments/create-intent` via fetch/POST.
      - name: embed_pyshiny
        mode: debug
        description: Run `shiny run ui/shiny/app.py --reload` and embed via iframe in `hybrid_shiny.html`.
      - name: export_shinylive
        mode: debug
        description: Export static app: `shinylive export ui/shiny site/` and embed in Django template as local assets.
        notes: "Shinylive enables Shiny apps to run entirely in the browser—no server—ideal for embedding."  # Shinylive capability [2](https://rstudio.github.io/cheatsheets/html/shiny-python.html)

  # ===== Receipts & Boarding Pass =====
  - id: settlement_receipts
    phase: receipts
    goal: "Finalize settlement; send emails and boarding pass PDF with breakdown."
    mode: architect
    outputs:
      files:
        - apps/receipts/boarding_pass.py
        - apps/receipts/emails.py
        - tests/test_receipts.py
    steps:
      - name: design
        mode: architect
      - name: implement
        mode: code
      - name: debug
        mode: debug

  # ===== Scheduler (No Celery) =====
  - id: points_expiry
    phase: scheduler
    goal: "Expire points per policy; remind users on partial invoices."
    mode: architect
    outputs:
      files:
        - flight/management/commands/expire_points.py
        - flight/management/commands/send_payment_reminders.py
        - tests/test_scheduler.py
    steps:
      - name: design
        mode: architect
      - name: implement
        mode: code
      - name: debug
        mode: debug

  # ===== Local perf & logging =====
  - id: performance_local
    phase: perf
    goal: "Local-memory cache & structured logs for heavy endpoints."
    mode: architect
    outputs:
      files:
        - capstone/settings_cache.py
        - capstone/settings_logging.py
        - tests/test_caching.py
    steps:
      - name: design
        mode: architect
      - name: implement
        mode: code
      - name: debug
        mode: debug

validation:
  - check: "python manage.py makemigrations --check --dry-run"
  - check: "pytest -q"
