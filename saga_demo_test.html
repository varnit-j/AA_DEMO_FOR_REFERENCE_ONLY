
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAGA Demo Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>üîß SAGA Transaction Demo</h2>
        <p>This demo shows how SAGA pattern handles distributed transaction failures with compensation.</p>
        
        <!-- SAGA Failure Simulation Section -->
        <div class="saga-demo-section" style="margin-top: 20px !important; padding: 15px !important; background-color: #fff3cd !important; border: 2px solid #ffeaa7 !important; border-radius: 8px !important; display: block !important; visibility: visible !important; z-index: 1000 !important;">
            <h5 style="color: #856404 !important; margin-bottom: 15px !important; background: none !important; -webkit-text-fill-color: #856404 !important;">üîß SAGA Demo Controls</h5>
            <p style="font-size: 12px !important; color: #856404 !important; margin-bottom: 15px !important;">
                Toggle switches to simulate transaction failures and demonstrate SAGA compensation
            </p>
            <hr style="border-color: #ffeaa7 !important;">
            
            <!-- Reserve Seat Failure -->
            <div class="form-check" style="margin-bottom: 10px;">
                <input class="form-check-input" type="checkbox" name="simulate_reserveseat_fail" id="simulateReserveSeatFail">
                <label class="form-check-label" for="simulateReserveSeatFail" style="font-size: 13px; color: #856404;">
                    <strong>Simulate Seat Reservation Failure</strong>
                    <br><small>Fails at step 1 - no compensation needed</small>
                </label>
            </div>
            
            <!-- Payment Authorization Failure -->
            <div class="form-check" style="margin-bottom: 10px;">
                <input class="form-check-input" type="checkbox" name="simulate_authorizepayment_fail" id="simulatePaymentFail">
                <label class="form-check-label" for="simulatePaymentFail" style="font-size: 13px; color: #856404;">
                    <strong>Simulate Payment Authorization Failure</strong>
                    <br><small>Fails at step 2 - compensates seat reservation</small>
                </label>
            </div>
            
            <!-- Miles Award Failure -->
            <div class="form-check" style="margin-bottom: 10px;">
                <input class="form-check-input" type="checkbox" name="simulate_awardmiles_fail" id="simulateMilesFail">
                <label class="form-check-label" for="simulateMilesFail" style="font-size: 13px; color: #856404;">
                    <strong>Simulate Miles Award Failure</strong>
                    <br><small>Fails at step 3 - compensates payment & seat</small>
                </label>
            </div>
            
            <!-- Booking Confirmation Failure -->
            <div class="form-check" style="margin-bottom: 15px;">
                <input class="form-check-input" type="checkbox" name="simulate_confirmbooking_fail" id="simulateBookingFail">
                <label class="form-check-label" for="simulateBookingFail" style="font-size: 13px; color: #856404;">
                    <strong>Simulate Booking Confirmation Failure</strong>
                    <br><small>Fails at step 4 - compensates all previous steps</small>
                </label>
            </div>
            
            <div style="font-size: 11px; color: #856404; font-style: italic;">
                üí° Select one failure type to see SAGA compensation in action
            </div>
            
            <!-- Demo Execution Button -->
            <div style="margin-top: 15px; text-align: center;">
                <button id="runSagaDemo" onclick="runSelectedDemo()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">
                    üöÄ Run SAGA Demo
                </button>
            </div>
        </div>

        <!-- SAGA Steps Display Container -->
        <div id="saga-steps-container" style="margin-top: 20px; display: none;">
            <h5 style="color: #495057; margin-bottom: 15px;">üìä SAGA Transaction Steps</h5>
            <div id="saga-steps" style="background: #ffffff; padding: 15px; border: 2px solid #dee2e6; border-radius: 8px;">
                <!-- Steps will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // SAGA Demo Helper Functions with Enhanced Logging
        let sagaLogContainer = null;

        function initializeSagaLogger() {
            if (!sagaLogContainer) {
                sagaLogContainer = document.createElement('div');
                sagaLogContainer.id = 'saga-log-container';
                sagaLogContainer.style.cssText = `
                    background: #f8f9fa;
                    border: 2px solid #dee2e6;
                    border-radius: 8px;
                    padding: 15px;
                    margin: 20px 0;
                    max-height: 400px;
                    overflow-y: auto;
                    font-family: 'Courier New', monospace;
                    font-size: 12px;
                `;
                sagaLogContainer.innerHTML = `
                    <h5 style="color: #495057; margin-bottom: 15px; font-family: Arial, sans-serif;">üìã SAGA Transaction Logs</h5>
                    <div id="saga-logs" style="background: #ffffff; padding: 10px; border: 1px solid #dee2e6; border-radius: 4px; min-height: 200px;"></div>
                `;
                
                // Insert after saga demo section
                const demoSection = document.querySelector('.saga-demo-section');
                if (demoSection) {
                    demoSection.parentNode.insertBefore(sagaLogContainer, demoSection.nextSibling);
                }
            }
            return document.getElementById('saga-logs');
        }

        function logSagaEvent(message, type = 'info', timestamp = true) {
            const logsContainer = initializeSagaLogger();
            const time = timestamp ? new Date().toLocaleTimeString() : '';
            
            const typeColors = {
                'info': '#17a2b8',
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107',
                'compensation': '#fd7e14'
            };
            
            const typeIcons = {
                'info': '‚ÑπÔ∏è',
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'compensation': 'üîÑ'
            };
            
            const logEntry = document.createElement('div');
            logEntry.style.cssText = `
                margin-bottom: 5px;
                padding: 5px 8px;
                border-left: 3px solid ${typeColors[type]};
                background: ${type === 'error' ? '#f8d7da' : type === 'success' ? '#d4edda' : type === 'compensation' ? '#fff3cd' : '#d1ecf1'};
                border-radius: 3px;
            `;
            
            logEntry.innerHTML = `
                <span style="color: ${typeColors[type]}; font-weight: bold;">${typeIcons[type]} ${type.toUpperCase()}</span>
                ${time ? `<span style="color: #6c757d; margin-left: 10px;">[${time}]</span>` : ''}
                <span style="margin-left: 10px;">${message}</span>
            `;
            
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        function clearSagaLogs() {
            const logsContainer = document.getElementById('saga-logs');
            if (logsContainer) {
                logsContainer.innerHTML = '';
            }
        }

        function getFailureDescription(failureType) {
            const descriptions = {
                'simulate_reserveseat_fail': 'Seat Reservation Failure (Step 1)',
                'simulate_authorizepayment_fail': 'Payment Authorization Failure (Step 2)',
                'simulate_awardmiles_fail': 'Miles Award Failure (Step 3)',
                'simulate_confirmbooking_fail': 'Booking Confirmation Failure (Step 4)'
            };
            return descriptions[failureType] || 'Unknown Failure Type';
        }

        function runSelectedDemo() {
            // Find which checkbox is selected
            const checkboxes = document.querySelectorAll('input[type="checkbox"][name^="simulate_"]');
            let selectedFailure = null;
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedFailure = checkbox.name;
                }
            });
            
            if (!selectedFailure) {
                alert('Please select a failure type to simulate!');
                return;
            }
            
            // Show the steps container
            document.getElementById('saga-steps-container').style.display = 'block';
            
            // Run the demonstration
            demonstrateSagaSteps(selectedFailure);
        }

        function demonstrateSagaSteps(failureType) {
            const stepsContainer = document.getElementById('saga-steps');
            const steps = [
                { name: 'Reserve Seat', service: 'Backend Service', status: 'pending', action: 'Reserving seat for passenger', compensation: 'Release reserved seat' },
                { name: 'Authorize Payment', service: 'Payment Service', status: 'pending', action: 'Processing payment authorization', compensation: 'Reverse payment authorization' },
                { name: 'Award Miles', service: 'Loyalty Service', status: 'pending', action: 'Adding loyalty miles to account', compensation: 'Remove awarded miles' },
                { name: 'Confirm Booking', service: 'Backend Service', status: 'pending', action: 'Finalizing booking confirmation', compensation: 'Cancel booking confirmation' }
            ];
            
            // Clear previous logs and initialize
            clearSagaLogs();
            logSagaEvent('üöÄ Starting SAGA transaction demonstration', 'info');
            logSagaEvent(`Simulation mode: ${getFailureDescription(failureType)}`, 'warning');
            
            // Determine which step will fail
            const failureStep = {
                'simulate_reserveseat_fail': 0,
                'simulate_authorizepayment_fail': 1,
                'simulate_awardmiles_fail': 2,
                'simulate_confirmbooking_fail': 3
            }[failureType];
            
            logSagaEvent(`Transaction will fail at step ${failureStep + 1}: ${steps[failureStep].name}`, 'warning');
            logSagaEvent('Steps that will execute before failure:', 'info');
            for (let i = 0; i < failureStep; i++) {
                logSagaEvent(`  ${i + 1}. ${steps[i].name} - ${steps[i].action}`, 'info');
            }
            if (failureStep > 0) {
                logSagaEvent('Steps that will need compensation (in reverse order):', 'info');
                for (let i = failureStep - 1; i >= 0; i--) {
                    logSagaEvent(`  ${i + 1}. ${steps[i].name} - ${steps[i].compensation}`, 'compensation');
                }
            }
            logSagaEvent('‚îÄ'.repeat(50), 'info');
            
            // Create initial step display
            updateStepsDisplay(stepsContainer, steps);
            
            // Execute steps with delays to show progression
            let currentStep = 0;
            const executeStep = () => {
                if (currentStep < steps.length) {
                    logSagaEvent(`Starting Step ${currentStep + 1}: ${steps[currentStep].name}`, 'info');
                    logSagaEvent(`Service: ${steps[currentStep].service}`, 'info');
                    logSagaEvent(`Action: ${steps[currentStep].action}`, 'info');
                    
                    steps[currentStep].status = 'processing';
                    updateStepsDisplay(stepsContainer, steps);
                    
                    setTimeout(() => {
                        if (currentStep === failureStep) {
                            // This step fails
                            logSagaEvent(`‚ùå Step ${currentStep + 1} FAILED: ${steps[currentStep].name}`, 'error');
                            logSagaEvent(`Error: Simulated failure in ${steps[currentStep].service}`, 'error');
                            steps[currentStep].status = 'failed';
                            updateStepsDisplay(stepsContainer, steps);
                            
                            // Start compensation after a delay
                            setTimeout(() => {
                                startCompensation(stepsContainer, steps, currentStep);
                            }, 1000);
                        } else {
                            // This step succeeds
                            logSagaEvent(`‚úÖ Step ${currentStep + 1} SUCCESS: ${steps[currentStep].name}`, 'success');
                            logSagaEvent(`Completed: ${steps[currentStep].action}`, 'success');
                            steps[currentStep].status = 'success';
                            updateStepsDisplay(stepsContainer, steps);
                            currentStep++;
                            setTimeout(executeStep, 1000);
                        }
                    }, 1500);
                } else {
                    // All steps completed successfully
                    logSagaEvent('üéâ All steps completed successfully! Transaction committed.', 'success');
                }
            };
            
            setTimeout(executeStep, 500);
        }

        function updateStepsDisplay(container, steps) {
            container.innerHTML = steps.map((step, index) => {
                const statusIcon = {
                    'pending': '‚è≥',
                    'processing': 'üîÑ',
                    'success': '‚úÖ',
                    'failed': '‚ùå',
                    'compensated': 'üîÑ'
                }[step.status];
                
                const statusColor = {
                    'pending': '#6c757d',
                    'processing': '#007bff',
                    'success': '#28a745',
                    'failed': '#dc3545',
                    'compensated': '#fd7e14'
                }[step.status];
                
                return `
                    <div style="display: flex; align-items: center; margin-bottom: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px;">
                        <span style="font-size: 20px; margin-right: 10px;">${statusIcon}</span>
                        <div style="flex: 1;">
                            <strong>Step ${index + 1}: ${step.name}</strong><br>
                            <small style="color: ${statusColor};">${step.service}</small>
                        </div>
                        <div style="color: ${statusColor}; font-weight: bold;">
                            ${step.status.toUpperCase()}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function startCompensation(container, steps, failedStepIndex) {
            logSagaEvent('‚îÄ'.repeat(50), 'compensation');
            logSagaEvent('üîÑ SAGA COMPENSATION PHASE STARTED', 'compensation');
            logSagaEvent(`Failure occurred at Step ${failedStepIndex + 1}: ${steps[failedStepIndex].name}`, 'error');
            logSagaEvent(`Rolling back ${failedStepIndex} completed step(s) in reverse order...`, 'compensation');
            
            // Add compensation message
            const compensationDiv = document.createElement('div');
            compensationDiv.style.cssText = `
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                border-radius: 5px;
                padding: 15px;
                margin: 20px 0;
                color: #856404;
            `;
            compensationDiv.innerHTML = `
                <h4>üîÑ SAGA Compensation Started</h4>
                <p>Step ${failedStepIndex + 1} failed. Rolling back completed steps...</p>
            `;
            container.appendChild(compensationDiv);
            
            // Compensate completed steps in reverse order
            let compensationStep = failedStepIndex - 1;
            const compensateStep = () => {
                if (compensationStep >= 0) {
                    logSagaEvent(`üîÑ Compensating Step ${compensationStep + 1}: ${steps[compensationStep].name}`, 'compensation');
                    logSagaEvent(`Service: ${steps[compensationStep].service}`, 'compensation');
                    logSagaEvent(`Compensation Action: ${steps[compensationStep].compensation}`, 'compensation');
                    
                    steps[compensationStep].status = 'compensated';
                    updateStepsDisplay(container, steps);
                    
                    logSagaEvent(`‚úÖ Step ${compensationStep + 1} compensated successfully`, 'compensation');
                    compensationStep--;
                    setTimeout(compensateStep, 1000);
                } else {
                    // Compensation complete
                    logSagaEvent('‚îÄ'.repeat(50), 'compensation');
                    logSagaEvent('üîÑ SAGA COMPENSATION COMPLETED', 'compensation');
                    logSagaEvent('All completed steps have been rolled back successfully', 'compensation');
                    logSagaEvent('‚ùå SAGA TRANSACTION FAILED - System returned to initial state', 'error');
                    
                    setTimeout(() => {
                        const finalDiv = document.createElement('div');
                        finalDiv.style.cssText = `
                            background: #f8d7da;
                            border: 1px solid #f5c6cb;
                            border-radius: 5px;
                            padding: 15px;
                            margin: 20px 0;
                            color: #721c24;
                        `;
                        finalDiv.innerHTML = `
                            <h4>‚ùå SAGA Transaction Failed</h4>
                            <p>All completed steps have been compensated. The booking has been rolled back.</p>
                        `;
                        container.appendChild(finalDiv);
                    }, 500);
                }
            };
            
            setTimeout(compensateStep, 1000);
        }

        // Ensure only one checkbox is selected at a time
        document.addEventListener('DOMContentLoaded', function() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"][name^="simulate_"]');
            
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        // Uncheck all other checkboxes
                        checkboxes.forEach(other => {
                            if (other !== this) {
                                other.checked = false;
                            }
                        });
                    }
                });
            });
        });
    </script>
</body>
</html>